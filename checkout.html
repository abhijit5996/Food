<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - FoodExpress</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* Page transition animations */
      body {
          opacity: 0;
          animation: fadeIn 0.5s ease-in forwards;
      }
      
      @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
      }
      
      /* Link transitions */
      a, button {
          transition: all 0.3s ease;
      }
    </style>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: "#ef4444",
              secondary: "#f97316",
              dark: "#1f2937",
              light: "#f3f4f6",
            },
            animation: {
              click: "click 300ms ease-out",
            },
            keyframes: {
              click: {
                "0%, 100%": { transform: "scale(1)" },
                "50%": { transform: "scale(0.95)" },
              },
            },
          },
        },
      };
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <!-- Navigation Bar -->
    <header class="bg-white dark:bg-gray-800 shadow-md transition-colors duration-300">
      <div
        class="container mx-auto flex p-5 flex-col md:flex-row items-center justify-between"
      >
        <a
          href="index.html"
          class="flex title-font font-medium items-center text-gray-900 dark:text-white mb-4 md:mb-0"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-10 h-10 text-white p-2 bg-primary rounded-full"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"
            />
          </svg>
          <span class="ml-3 text-xl font-bold"
            >Food<span class="text-primary">Express</span></span
          >
        </a>
        <nav class="flex flex-wrap items-center justify-center md:ml-auto">
          <a href="index.html" class="mr-5 hover:text-primary transition dark:text-gray-300 dark:hover:text-primary">Home</a>
          <a href="menu.html" class="mr-5 hover:text-primary transition dark:text-gray-300 dark:hover:text-primary">Menu</a>
          <a href="orders.html" class="mr-5 hover:text-primary transition dark:text-gray-300 dark:hover:text-primary">My Orders</a>
        </nav>
        <div class="inline-flex items-center mt-4 md:mt-0">
          <button id="theme-toggle" class="p-2 rounded-lg focus:outline-none text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 mr-4">
              <i class="fas fa-moon dark:hidden"></i>
              <i class="fas fa-sun hidden dark:block"></i>
          </button>
          <a
            href="cart.html"
            class="inline-flex items-center bg-gray-100 dark:bg-gray-700 text-dark dark:text-white border-0 py-1 px-3 focus:outline-none hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-base md:mt-0 transition"
          >
            <i class="fas fa-shopping-cart mr-2 text-primary"></i>Cart
            <span
              id="cart-count"
              class="ml-1 bg-primary text-white rounded-full text-xs py-0.5 px-1.5"
              >0</span
            >
          </a>
        </div>
      </div>
    </header>

    <!-- Checkout Section -->
    <section class="text-gray-600 dark:text-gray-300 body-font py-12 transition-colors duration-300">
      <div class="container px-5 mx-auto">
        <div class="flex flex-col text-center w-full mb-12">
          <h1
            class="text-3xl font-bold title-font mb-4 text-dark dark:text-white"
          >
            Complete Your Order
          </h1>
          <p class="lg:w-2/3 mx-auto leading-relaxed">
            Please provide your delivery details and payment information
          </p>
        </div>

        <div class="lg:w-2/3 mx-auto">
          <div class="flex flex-wrap -mx-2">
            <div class="w-full lg:w-1/2 px-2 mb-8 lg:mb-0">
              <div
                class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 h-full transition-colors duration-300"
              >
                <h2 class="text-xl font-bold mb-4 text-dark dark:text-white">
                  Delivery Information
                </h2>

                <form id="deliveryForm">
                  <div class="mb-4">
                    <label
                      for="name"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                      >Full Name</label
                    >
                    <input
                      type="text"
                      id="name"
                      name="name"
                      required
                      class="w-full bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 focus:border-primary focus:bg-white dark:focus:bg-gray-600 focus:ring-2 focus:ring-red-200 text-base outline-none text-gray-700 dark:text-white py-1 px-3 leading-8 transition-colors duration-200 ease-in-out"
                    />
                  </div>

                  <div class="mb-4">
                    <label
                      for="phone"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                      >Phone Number</label
                    >
                    <input
                      type="tel"
                      id="phone"
                      name="phone"
                      required
                      class="w-full bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 focus:border-primary focus:bg-white dark:focus:bg-gray-600 focus:ring-2 focus:ring-red-200 text-base outline-none text-gray-700 dark:text-white py-1 px-3 leading-8 transition-colors duration-200 ease-in-out"
                    />
                  </div>

                  <div class="mb-4">
                    <label
                      for="address"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                      >Delivery Address</label
                    >
                    <textarea
                      id="address"
                      name="address"
                      rows="3"
                      required
                      class="w-full bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 focus:border-primary focus:bg-white dark:focus:bg-gray-600 focus:ring-2 focus:ring-red-200 text-base outline-none text-gray-700 dark:text-white py-1 px-3 leading-8 transition-colors duration-200 ease-in-out"
                    ></textarea>
                  </div>

                  <div class="mb-4">
                    <label
                      for="instructions"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                      >Delivery Instructions (Optional)</label
                    >
                    <textarea
                      id="instructions"
                      name="instructions"
                      rows="2"
                      class="w-full bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 focus:border-primary focus:bg-white dark:focus:bg-gray-600 focus:ring-2 focus:ring-red-200 text-base outline-none text-gray-700 dark:text-white py-1 px-3 leading-8 transition-colors duration-200 ease-in-out"
                    ></textarea>
                  </div>
                </form>
              </div>
            </div>

            <div class="w-full lg:w-1/2 px-2">
              <div
                class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 h-full transition-colors duration-300"
              >
                <h2 class="text-xl font-bold mb-4 text-dark dark:text-white">
                  Order Summary
                </h2>

                <div id="order-summary" class="mb-6">
                  <!-- Order items will be dynamically inserted here -->
                  <p class="text-gray-500 dark:text-gray-400">
                    Loading your cart items...
                  </p>
                </div>

                <div
                  class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-6"
                >
                  <div class="flex justify-between mb-2">
                    <span class="text-gray-600 dark:text-gray-300"
                      >Subtotal</span
                    >
                    <span id="subtotal" class="text-gray-900 dark:text-white"
                      >₹0.00</span
                    >
                  </div>
                  <div class="flex justify-between mb-2">
                    <span class="text-gray-600 dark:text-gray-300"
                      >Delivery Fee</span
                    >
                    <span
                      id="delivery-fee"
                      class="text-gray-900 dark:text-white"
                      >₹30.00</span
                    >
                  </div>
                  <div class="flex justify-between font-bold text-lg">
                    <span class="text-gray-900 dark:text-white">Total</span>
                    <span id="total" class="text-primary">₹30.00</span>
                  </div>
                </div>

                <h3
                  class="text-lg font-semibold mb-3 text-dark dark:text-white"
                >
                  Payment Method
                </h3>
                <div class="space-y-3 mb-6">
                  <div class="flex items-center">
                    <input
                      id="cash-on-delivery"
                      name="payment-method"
                      type="radio"
                      checked
                      class="h-4 w-4 text-primary focus:ring-primary border-gray-300 dark:border-gray-600"
                    />
                    <label
                      for="cash-on-delivery"
                      class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Cash on Delivery</label
                    >
                  </div>
                  <div class="flex items-center">
                    <input
                      id="credit-card"
                      name="payment-method"
                      type="radio"
                      class="h-4 w-4 text-primary focus:ring-primary border-gray-300 dark:border-gray-600"
                    />
                    <label
                      for="credit-card"
                      class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Credit/Debit Card</label
                    >
                  </div>
                  <div class="flex items-center">
                    <input
                      id="upi"
                      name="payment-method"
                      type="radio"
                      class="h-4 w-4 text-primary focus:ring-primary border-gray-300 dark:border-gray-600"
                    />
                    <label
                      for="upi"
                      class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >UPI Payment</label
                    >
                  </div>
                </div>

                <button
                  id="place-order-btn"
                  class="w-full bg-primary text-white py-3 rounded-lg hover:bg-red-600 transition font-bold"
                >
                  Place Order
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer
      class="text-gray-600 dark:text-gray-300 body-font bg-white dark:bg-gray-800 transition-colors duration-300"
    >
      <div
        class="container px-5 py-8 mx-auto flex items-center sm:flex-row flex-col"
      >
        <a
          href="index.html"
          class="flex title-font font-medium items-center md:justify-start justify-center text-gray-900 dark:text-white"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-10 h-10 text-white p-2 bg-primary rounded-full"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"
            />
          </svg>
          <span class="ml-3 text-xl font-bold"
            >Food<span class="text-primary">Express</span></span
          >
        </a>
        <p
          class="text-sm text-gray-500 dark:text-gray-400 sm:ml-4 sm:pl-4 sm:border-l-2 sm:border-gray-200 dark:sm:border-gray-700 sm:py-2 sm:mt-0 mt-4"
        >
          © 2023 FoodExpress —
          <a
            href="#"
            class="text-gray-600 dark:text-gray-300 ml-1"
            rel="noopener noreferrer"
            target="_blank"
            >All Rights Reserved</a
          >
        </p>
        <span
          class="inline-flex sm:ml-auto sm:mt-0 mt-4 justify-center sm:justify-start"
        >
          <a
            href="#"
            class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary"
          >
            <i class="fab fa-facebook-f"></i>
          </a>
          <a
            href="#"
            class="ml-3 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary"
          >
            <i class="fab fa-twitter"></i>
          </a>
          <a
            href="#"
            class="ml-3 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary"
          >
            <i class="fab fa-instagram"></i>
          </a>
        </span>
      </div>
    </footer>

    <!-- Loading indicator -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden"
    >
      <div
        class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl text-center transition-colors duration-300"
      >
        <div
          class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mx-auto"
        ></div>
        <p class="mt-4 text-gray-900 dark:text-white">
          Processing your order...
        </p>
      </div>
    </div>

    <!-- Scripts -->
    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;

        // Check for saved user preference or use system preference
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
        } else {
            html.classList.remove('dark');
        }

        // Toggle theme
        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
        });
    </script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getDatabase,
        ref,
        get,
        push,
        update,
        increment,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBx0Kt9o04ye0XrtA8ecp84wD8Q9OCDjlA",
        authDomain: "foodorder-4380c.firebaseapp.com",
        databaseURL: "https://foodorder-4380c-default-rtdb.firebaseio.com",
        projectId: "foodorder-4380c",
        storageBucket: "foodorder-4380c.firebasestorage.app",
        messagingSenderId: "735023580381",
        appId: "1:735023580381:web:c6740bef2fc9bdee1b4734",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const database = getDatabase(app);

      // Cart counter
      function updateCartCounter() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const count = cart.reduce((total, item) => total + item.quantity, 0);
        document.getElementById("cart-count").textContent = count;
      }

      // Update cart counter on page load
      updateCartCounter();

      // Check auth state
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          localStorage.setItem("redirectAfterLogin", "checkout.html");
          window.location.href = "login.html";
        } else {
          loadUserData(user.uid);
          loadCartItems();
        }
      });

      async function loadUserData(userId) {
        try {
          const userRef = ref(database, "users/" + userId);
          const snapshot = await get(userRef);

          if (snapshot.exists()) {
            const userData = snapshot.val();
            if (userData.deliveryInfo) {
              document.getElementById("name").value =
                userData.deliveryInfo.name || "";
              document.getElementById("phone").value =
                userData.deliveryInfo.phone || "";
              document.getElementById("address").value =
                userData.deliveryInfo.address || "";
              document.getElementById("instructions").value =
                userData.deliveryInfo.instructions || "";
            }
          }
        } catch (error) {
          console.error("Error loading user data:", error);
          showErrorMessage(
            "Failed to load your information. Please refresh the page or try again later."
          );
        }
      }

      function loadCartItems() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const orderSummary = document.getElementById("order-summary");
        const subtotalElement = document.getElementById("subtotal");
        const totalElement = document.getElementById("total");

        orderSummary.innerHTML = "";

        if (cart.length === 0) {
          orderSummary.innerHTML =
            '<p class="text-gray-500 dark:text-gray-400">Your cart is empty</p>';
          subtotalElement.textContent = "₹0.00";
          totalElement.textContent = "₹30.00";
          return;
        }

        let subtotal = 0;

        cart.forEach((item) => {
          const itemTotal = item.price * item.quantity;
          subtotal += itemTotal;

          const itemElement = document.createElement("div");
          itemElement.className =
            "flex justify-between py-2 border-b border-gray-200 dark:border-gray-700";
          itemElement.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-gray-900 dark:text-white font-medium">${
                          item.quantity
                        } × ${item.name}</span>
                    </div>
                    <span class="text-gray-900 dark:text-white">₹${itemTotal.toFixed(
                      2
                    )}</span>
                `;
          orderSummary.appendChild(itemElement);
        });

        const deliveryFee = 30;
        const total = subtotal + deliveryFee;

        subtotalElement.textContent = `₹${subtotal.toFixed(2)}`;
        totalElement.textContent = `₹${total.toFixed(2)}`;
      }

      // Form validation function
      function validateForm() {
        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const address = document.getElementById("address").value.trim();

        if (!name) {
          showErrorMessage("Please enter your full name");
          return false;
        }

        if (!phone) {
          showErrorMessage("Please enter your phone number");
          return false;
        }

        // Basic phone validation
        if (!/^\d{10}$/.test(phone.replace(/[\s-]/g, ""))) {
          showErrorMessage("Please enter a valid 10-digit phone number");
          return false;
        }

        if (!address) {
          showErrorMessage("Please enter your delivery address");
          return false;
        }

        return true;
      }

      // Show loading indicator
      function showLoading() {
        document.getElementById("loading-overlay").classList.remove("hidden");
      }

      // Hide loading indicator
      function hideLoading() {
        document.getElementById("loading-overlay").classList.add("hidden");
      }

      // Show error message
      function showErrorMessage(message) {
        // Create error element
        const errorElement = document.createElement("div");
        errorElement.className =
          "fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50";
        errorElement.textContent = message;

        // Add to body
        document.body.appendChild(errorElement);

        // Remove after 3 seconds
        setTimeout(() => {
          errorElement.remove();
        }, 3000);
      }

      // Show success message
      function showSuccessMessage(message) {
        // Create success element
        const successElement = document.createElement("div");
        successElement.className =
          "fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50";
        successElement.textContent = message;

        // Add to body
        document.body.appendChild(successElement);

        // Remove after 3 seconds
        setTimeout(() => {
          successElement.remove();
        }, 3000);
      }

      // Place order button functionality
      document
        .getElementById("place-order-btn")
        .addEventListener("click", async function () {
          // Check if user is logged in
          const user = auth.currentUser;
          if (!user) {
            localStorage.setItem("redirectAfterLogin", "checkout.html");
            window.location.href = "login.html";
            return;
          }

          // Get the cart from localStorage
          const cart = JSON.parse(localStorage.getItem("cart")) || [];

          if (cart.length === 0) {
            showErrorMessage("Your cart is empty!");
            return;
          }

          // Validate form first
          if (!validateForm()) {
            return;
          }

          // Show loading overlay
          showLoading();

          // Get the delivery form data
          const deliveryForm = document.getElementById("deliveryForm");
          const formData = {
            name: deliveryForm.elements.name.value.trim(),
            phone: deliveryForm.elements.phone.value.trim(),
            address: deliveryForm.elements.address.value.trim(),
            instructions: deliveryForm.elements.instructions.value.trim(),
            paymentMethod: document.querySelector(
              'input[name="payment-method"]:checked'
            ).id,
          };

          // Calculate order total
          const subtotal = cart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0
          );
          const deliveryFee = 30;
          const total = subtotal + deliveryFee;

          // Create order object
          const order = {
            userId: user.uid,
            userEmail: user.email,
            items: [...cart],
            deliveryDetails: formData,
            subtotal: subtotal,
            deliveryFee: deliveryFee,
            total: total,
            status: "active",
            statusText: "Preparing",
            timestamp: serverTimestamp(),
            createdAt: new Date().toISOString(),
          };

          try {
            // Save order to Realtime Database
            const ordersRef = ref(database, "orders");
            const newOrderRef = push(ordersRef);

            // Get the generated order ID
            const orderId = newOrderRef.key;

            // Add order ID to the order object
            order.orderId = orderId;

            // Save the order
            await update(newOrderRef, order);

            // Update user's order count and save delivery info
            const userRef = ref(database, "users/" + user.uid);
            await update(userRef, {
              totalOrders: increment(1),
              lastOrder: new Date().toISOString(),
              deliveryInfo: formData,
            });

            // Update user's orders list
            const userOrdersRef = ref(
              database,
              `users/${user.uid}/orders/${orderId}`
            );
            await update(userOrdersRef, {
              orderId: orderId,
              total: total,
              status: "active",
              statusText: "Preparing",
              timestamp: serverTimestamp(),
              createdAt: new Date().toISOString(),
            });

            // Clear the cart
            localStorage.removeItem("cart");

            // Update cart counter
            updateCartCounter();

            // Hide loading overlay
            hideLoading();

            // Show success message
            showSuccessMessage("Your order has been placed successfully!");

            // Redirect to orders page after a small delay
            setTimeout(() => {
              window.location.href = "orders.html";
            }, 1500);
          } catch (error) {
            // Hide loading overlay
            hideLoading();

            console.error("Error placing order:", error);
            showErrorMessage(
              "There was an error placing your order. Please try again."
            );
          }
        });
           // Add smooth transition to all links
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', function(e) {
                // Don't apply to:
                // 1. External links
                // 2. Anchor links (#)
                // 3. Links to the current page
                if (!this.href || 
                    this.href.startsWith('http') || 
                    this.href.includes('#') || 
                    this.href === window.location.href) {
                    return;
                }
                
                e.preventDefault();
                document.body.style.opacity = '0';
                document.body.style.transition = 'opacity 0.3s ease';
                
                setTimeout(() => {
                    window.location.href = this.href;
                }, 300);
            });
        });
    });
    </script>
  </body>
</html>